name: Python package

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  lint:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: [3.8]
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8
        pip install .
    - name: Setup flake8 annotations
      uses: rbialon/flake8-annotations@v1
    - name: Run flake8
      run: |
        flake8 clifford --show-source --statistics

  build:
    needs: lint
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # fastest jobs first
          - python-version: 3.8
            name: NUMBA_DISABLE_JIT
            disable_jit: 1
          - python-version: 3.8
            mode: doctests
          # really slow job next, so it runs in parallel with the others
          - python-version: 3.8
            mode: very_slow
          - python-version: 3.5
          - python-version: 3.8
          - python-version: 3.8
            conda: true
          - python-version: 3.8
            mode: bench

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies (conda)
      if: matrix.conda
      run: |
        echo $CONDA/bin >> $GITHUB_PATH
        conda install \
          "numpy>=1.17.0" \
          scipy \
          pip \
          IPython \
          h5py;
        conda install -c conda-forge sparse;
        conda install -c numba "numba>=0.45.1";
        conda activate base;
        # make sure in conda we do not overwrite dependencies with pip
        python setup.py develop --no-deps;
        # test dependencies
        pip install --upgrade pytest pytest-cov pytest-benchmark;
    
    - name: Install dependencies (pip)
      if: "!matrix.conda"
      run: |
        python -m pip install --upgrade pip;
        pip install . --prefer-binary;
        # test dependencies
        pip install --upgrade pytest pytest-cov pytest-benchmark IPython
    - name: Test with pytest
      env:
        MODE: ${{ matrix.mode }}
        NUMBA_DISABLE_JIT: ${{ matrix.disable_jit }}
      run: |
        PYTEST_ARGS=();
        if [[ "${MODE}" == "bench" ]]; then
          PYTEST_ARGS+=(--benchmark-only);
        else
          PYTEST_ARGS+=(--benchmark-skip);
        fi;
        if [[ "${MODE}" == "very_slow" ]]; then
          PYTEST_ARGS+=(-m "veryslow");
        else
          PYTEST_ARGS+=(-m "not veryslow");
        fi;
        if [[ "${MODE}" == "doctests" ]]; then
          PYTEST_ARGS+=(--doctest-modules --ignore clifford/test);
        fi;

        pytest \
          "${PYTEST_ARGS[@]}" \
          --color=yes \
          -o junit_family=legacy \
          --junitxml=junit/test-results.xml \
          --durations=25 \
          --cov=clifford \
          --cov-branch;
    - name: Publish Test Report
      uses: mikepenz/action-junit-report@v2
      if: ${{ always() }}
      with:
        report_paths: 'junit/test-results.xml'
    - uses: codecov/codecov-action@v1
